/*can1_driver.c*/
#include <LPC21xx.H>
#include "header.h"

void can1_init(void)
{
	PINSEL1|=0x40000;//P0.25--> RD1
	VPBDIV=1;//PCLK=60MHz
	C1MOD=1;//reset mode
	C1BTR=0x001C001D;//125Kbps baudrate
	AFMR=2;//Accept all receiving data-frames
	C1MOD=0;//release reset mode
}


#define TCS ((C1GSR>>3)&1)
void can1_tx(CAN1 v)
{
	C1TID1=v.id;
	C1TFI1=(v.dlc<<16);//Set DLC, RTR=0, FF=0
	
	if(v.rtr==0)
	{//if data-frame
		C1TDA1=v.byteA;
		C1TDB1=v.byteB;
	}
	else
	C1TFI1|=(1<<30);//rtr=1
	
	C1CMR=1|(1<<5);//Start Xmission & select Txbuf1
	//C1CMR=0x21;
	while(((C1GSR>>3)&1)==0);
}
